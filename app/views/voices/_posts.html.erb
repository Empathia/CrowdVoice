<%
    infosidebarIsPresent = false
    if !@blocks.empty?
      if params[:tags].present? || params['all'].present?
        infosidebarIsPresent = true
      end
    end
 %>
<script type="text/template" id="timeline-deactivated">
  <li class="timeliner disactivated-timeliner" data-year="{{year}}">
    <a href="#"><span class="timerliner-dot"></span><span class="year-label"><span class="inner-dot-icn"></span><span class="year-text">{{year}}</span></span></a>
  </li>
</script>
<div class="top-scroll" style="z-index:1;position:fixed;cursor:n-resize;width: 100%; height: 50px; right: 60px"></div>
<div class="bottom-scroll" style="z-index:1;position:fixed;cursor:s-resize;width: 100%; height: 50px; right: 60px"></div>
<div class="sweeper panel-padding">

  <div class="updating-wrapper" <%= "style=\"background-image:url('#{@voice.background}')\"".html_safe if !@voice.background.blank? %> <%= "data-background-loading-image=\"#{@voice.background}\"".html_safe if !@voice.background.blank? %> >
    <div class="image-bg-patter">
      <div class="loading-hldr">
        <div class="loading-wrapper">
          <div class="spinner">
            <%= image_tag '/images/loader-posts.gif', :border => '0' %>
            <p>Loading Voice</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!--style type="text/css" class="posts-style">
    /*placeholder for dynamically calculated posts styles*/
    /* used by mediafeed_init.js/setPostsmeasures()*/
  </style-->

  <!-- infographics sidebar render only on POSTS WALL view -->
  <% if  infosidebarIsPresent && !is_mobile? %>
    <%= render :partial => "voices/info-sidebar" %>
  <% end %>

  <div class="voices-scroller scroll-primary <%= 'with-infosidebar' if infosidebarIsPresent %>" style="height: 1167px; width: 959px;">
    <div class="voices-container initial-state <%= 'with-announcement' if @voice.announcement.present? %>" style="width: 800px; overflow: hidden; position: relative; height: 564px;">
      <div class="placeholders">
      <% 30.times do %>
        <img src="/images/voice-placeholder.gif" style="margin:5px;" />
      <% end %>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    $(document).ready(function(){

      CV.voicesContainer = new VoicesContainer({
        name     : 'voicesContainer',
        element  : $('.voices-container'),
        perPage  : <%= per_page = (is_mobile? ? Setting.posts_per_page_on_mobile : Setting.posts_per_page).to_i %>
      });

      CV.OverlaysController = new OverlaysController();

      // var page = CV.voicesContainer.currentPage;

      var page = 0;

      // CV.voicesContainer.renderPages();

      var params = '?page=' + page;

      if ($.deparam.querystring().mod) {
          params += '&mod=1';
      }

      params += "&fetchAll=1"

      $.ajax({
        dataType  : "json",
        async     : true,
        url       : location.pathname + params,
        success   : function(data) {
          data.forEach(function(item) {
            var post = {};

            post.id = item[0];
            post.voice_id = item[1];
            post.user_id = item[2];
            post.title = item[3];
            post.description = item[4];
            post.positive_votes_count = item[5];
            post.negative_votes_count = item[6];
            post.overall_score = item[7];
            post.source_url = item[8];
            post.source_type = item[9];
            post.source_service = item[10];
            post.image = item[11];
            post.approved = item[12];
            post.created_at = item[13];
            post.updated_at = item[14];
            post.copyright = item[15];
            post.image_width = item[16];
            post.image_height = item[17];
            post.active = false;

            CV.voicesContainer.preloadedVoices.push(post);
          });

          
          CV.voicesContainer.page = page;
          // CV.voicesContainer.getNextPage(function() {

          // });

          CV.voicesContainer.createVoiceWidgets(function() {
            CV.voicesContainer.element.find('.placeholders').remove();
            
            CV.voicesContainer.element.isotope({
                transitionDuration: 0,
                animationEngine: $.browser.mozilla || $.browser.msie ? 'jquery' : 'best-available',
                 animationOptions: {
                    duration: 0,
                    easing: 'linear',
                    queue: false
                },
                resizable: false,
                itemSelector: '.voice-box',
                filter : function() {
                  return !$(this).hasClass('disabled');
                },
                masonry: {
                    columnWidth: 200 - 5
                },
                callback: function(){
                    $('.updating-wrapper').hide();
                    $('body').css('overflow', 'hidden');
                    $('.voice-wrapper').removeClass('initial-state');
                    DynamicMeasures.update();
                    // re-trigger resize to help slow devices on proper arrangement
                    setTimeout(function(){$(window).smartresize();}, 500);
                }
            });
            
            window.isotopeReady = true;

            CV.voicesContainer.enableNextPage();
          });

          CV.mediaFeedSearch.reloadFuse(); 
        }
      });

      CV.mediaFeedSearch = new MediaFeedSearch({
        element : $('.mediafeed-search')
      });
    });
  </script>



  <ul class="timeliner-group <%= 'with-announcement' if @voice.announcement.present? %>">
    <li class="post-fetch-trigger timeline-tab _medium-font">See More</li>
    <li class="timeliner current">
      <div id="slider-vertical"></div>
    </li>
  </ul>
</div>


